{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Transform": "AWS::Serverless-2016-10-31",
  "Description": "Dogotel Backend API for AWS Learner Lab",

  "Globals": {
    "Function": {
      "Runtime": "nodejs18.x",
      "Timeout": 30,
      "MemorySize": 256,
      "Architectures": ["x86_64"]
    },
    "Api": {
      "Cors": {
        "AllowMethods": "'*'",
        "AllowHeaders": "'*'",
        "AllowOrigin": "'*'"
      }
    }
  },

  "Parameters": {
    "ProjectName": { "Type": "String", "Default": "dogotel" },
    "CognitoDomainPrefix": {
      "Type": "String",
      "Default": "dogotel-auth"
    }
  },

  "Resources": {
    "ProxyApi": {
      "Type": "AWS::Serverless::Api",
      "Properties": {
        "StageName": "prod",
        "Cors": {
          "AllowMethods": "'*'",
          "AllowHeaders": "'*'",
          "AllowOrigin": "'*'"
        }
      }
    },
    "CognitoUserPool": {
      "Type": "AWS::Cognito::UserPool",
      "Properties": {
        "UserPoolName": "Dogotel-UserPool",
        "Schema": [
          {
            "Name": "email",
            "AttributeDataType": "String",
            "Mutable": true,
            "Required": true
          },
          {
            "Name": "birthdate",
            "AttributeDataType": "String",
            "Mutable": true
          },
          {
            "Name": "given_name",
            "AttributeDataType": "String",
            "Mutable": true
          },
          {
            "Name": "family_name",
            "AttributeDataType": "String",
            "Mutable": true
          }
        ],
        "Policies": {
          "PasswordPolicy": {
            "MinimumLength": 8,
            "RequireLowercase": true,
            "RequireNumbers": true,
            "RequireSymbols": true,
            "RequireUppercase": true
          }
        },
        "AutoVerifiedAttributes": ["email"]
      }
    },
    "CognitoUserPoolClient": {
      "Type": "AWS::Cognito::UserPoolClient",
      "Properties": {
        "ClientName": "dogotel-web-client",
        "UserPoolId": {
          "Ref": "CognitoUserPool"
        },
        "ExplicitAuthFlows": [
          "ALLOW_ADMIN_USER_PASSWORD_AUTH",
          "ALLOW_USER_PASSWORD_AUTH",
          "ALLOW_REFRESH_TOKEN_AUTH"
        ],
        "GenerateSecret": false
      }
    },
    "AuthHandlerLambda": {
      "Type": "AWS::Serverless::Function",
      "Properties": {
        "Handler": "src/handlers/auth_handler.handler",
        "Runtime": "nodejs18.x",
        "CodeUri": "aws",
        "Policies": [
          "AmazonDynamoDBFullAccess",
          "AmazonCognitoIdentityProviderFullAccess"
        ],
        "Environment": {
          "Variables": {
            "COGNITO_USER_POOL_ID": {
              "Ref": "CognitoUserPool"
            },
            "COGNITO_CLIENT_ID": {
              "Ref": "CognitoUserPoolClient"
            },
            "USERS_TABLE": {
              "Ref": "UsersTable"
            }
          }
        },
        "Events": {
          "ProxyApi": {
            "Type": "Api",
            "Properties": {
              "Path": "/auth/{proxy+}",
              "Method": "ANY",
              "RestApiId": {
                "Ref": "ProxyApi"
              }
            }
          }
        }
      }
    },
    "UserHandlerLambda": {
      "Type": "AWS::Serverless::Function",
      "Properties": {
        "Handler": "src/handlers/user_handler.handler",
        "Runtime": "nodejs18.x",
        "CodeUri": "aws",
        "Policies": [
          "AmazonDynamoDBFullAccess",
          "AmazonCognitoIdentityProviderFullAccess"
        ],
        "Environment": {
          "Variables": {
            "USERS_TABLE": {
              "Ref": "UsersTable"
            },
            "DOGS_TABLE": {
              "Ref": "DogsTable"
            },
            "USER_POOL_ID": {
              "Ref": "CognitoUserPool"
            }
          }
        },
        "Events": {
          "ProxyApi": {
            "Type": "Api",
            "Properties": {
              "Path": "/user/{proxy+}",
              "Method": "ANY",
              "RestApiId": {
                "Ref": "ProxyApi"
              }
            }
          }
        }
      }
    },
    "RekognitionHandlerLambda": {
      "Type": "AWS::Serverless::Function",
      "Properties": {
        "Handler": "src/handlers/rekognition_handler.handler",
        "Runtime": "nodejs18.x",
        "CodeUri": "aws",
        "Policies": ["RekognitionFullAccess"],
        "Events": {
          "ProxyApi": {
            "Type": "Api",
            "Properties": {
              "Path": "/api/rekognition/{proxy+}",
              "Method": "ANY",
              "RestApiId": {
                "Ref": "ProxyApi"
              }
            }
          }
        }
      }
    },
    "UsersTable": {
      "Type": "AWS::DynamoDB::Table",
      "Properties": {
        "TableName": "DogotelUsers",
        "AttributeDefinitions": [
          {
            "AttributeName": "email",
            "AttributeType": "S"
          }
        ],
        "KeySchema": [
          {
            "AttributeName": "email",
            "KeyType": "HASH"
          }
        ],
        "ProvisionedThroughput": {
          "ReadCapacityUnits": 1,
          "WriteCapacityUnits": 1
        }
      }
    },
    "DogsTable": {
      "Type": "AWS::DynamoDB::Table",
      "Properties": {
        "TableName": "DogotelDogs",
        "AttributeDefinitions": [
          {
            "AttributeName": "dogId",
            "AttributeType": "S"
          },
          {
            "AttributeName": "userEmail",
            "AttributeType": "S"
          }
        ],
        "KeySchema": [
          {
            "AttributeName": "dogId",
            "KeyType": "HASH"
          }
        ],
        "GlobalSecondaryIndexes": [
          {
            "IndexName": "UserEmailIndex",
            "KeySchema": [
              {
                "AttributeName": "userEmail",
                "KeyType": "HASH"
              }
            ],
            "Projection": {
              "ProjectionType": "ALL"
            },
            "ProvisionedThroughput": {
              "ReadCapacityUnits": 1,
              "WriteCapacityUnits": 1
            }
          }
        ],
        "ProvisionedThroughput": {
          "ReadCapacityUnits": 1,
          "WriteCapacityUnits": 1
        }
      }
    },
    "BookingsTable": {
      "Type": "AWS::DynamoDB::Table",
      "Properties": {
        "TableName": "DogotelBookings",
        "AttributeDefinitions": [
          {
            "AttributeName": "bookingId",
            "AttributeType": "S"
          },
          {
            "AttributeName": "userEmail",
            "AttributeType": "S"
          }
        ],
        "KeySchema": [
          {
            "AttributeName": "bookingId",
            "KeyType": "HASH"
          }
        ],
        "GlobalSecondaryIndexes": [
          {
            "IndexName": "UserEmailIndex",
            "KeySchema": [
              {
                "AttributeName": "userEmail",
                "KeyType": "HASH"
              }
            ],
            "Projection": {
              "ProjectionType": "ALL"
            },
            "ProvisionedThroughput": {
              "ReadCapacityUnits": 1,
              "WriteCapacityUnits": 1
            }
          }
        ],
        "ProvisionedThroughput": {
          "ReadCapacityUnits": 1,
          "WriteCapacityUnits": 1
        }
      }
    },
    "ApplicationParameters": {
      "Type": "AWS::SSM::Parameter",
      "Properties": {
        "Name": "/dogotel/config",
        "Type": "String",
        "Value": {
          "Fn::Sub": "{\"UserPoolId\":\"${CognitoUserPool}\",\"UserPoolClientId\":\"${CognitoUserPoolClient}\",\"ApiUrl\":\"https://${ProxyApi}.execute-api.${AWS::Region}.amazonaws.com/prod/\",\"UsersTableName\":\"${UsersTable}\",\"BookingsTableName\":\"${BookingsTable}\",\"DogsTableName\":\"${DogsTable}\"}"
        }
      }
    }
  },

  "Outputs": {
    "ApiUrl": {
      "Description": "API Gateway endpoint URL for Prod stage",
      "Value": {
        "Fn::Sub": "https://${ProxyApi}.execute-api.${AWS::Region}.amazonaws.com/prod/"
      }
    },
    "CognitoUserPoolId": {
      "Description": "Cognito User Pool ID",
      "Value": {
        "Ref": "CognitoUserPool"
      }
    },
    "CognitoUserPoolClientId": {
      "Description": "Cognito User Pool Client ID",
      "Value": {
        "Ref": "CognitoUserPoolClient"
      }
    }
  }
}
